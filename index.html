<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>転職Q&Aフォーラム - プロトタイプ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, orderBy, query, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCh3_5R59_Q9HwcvTlALvZiPOzg5n5YUvI",
            authDomain: "recruitproj-ccb43.firebaseapp.com",
            projectId: "recruitproj-ccb43",
            storageBucket: "recruitproj-ccb43.firebasestorage.app",
            messagingSenderId: "24003203574",
            appId: "1:24003203574:web:10764ed34cfcf06579f7d7",
            measurementId: "G-ZSGCF6N1FT"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();
        
        // Make Firebase available globally
        window.db = db;
        window.auth = auth;
        window.googleProvider = googleProvider;
        window.addDoc = addDoc;
        window.collection = collection;
        window.getDocs = getDocs;
        window.onSnapshot = onSnapshot;
        window.orderBy = orderBy;
        window.query = query;
        window.serverTimestamp = serverTimestamp;
        window.signInWithPopup = signInWithPopup;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
    </script>
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        .q-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .q-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
        }
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <div class="text-center flex-1">
                    <h1 class="text-3xl md:text-4xl font-bold text-blue-600">転職リアルQ&A</h1>
                    <p class="mt-2 text-gray-600">エージェントには聞きにくい「ホントのところ」、ここで見つかる・質問できる。</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="auth-buttons" class="hidden">
                        <button onclick="openLoginModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            ログイン
                        </button>
                    </div>
                    <div id="user-menu" class="hidden">
                        <div class="flex items-center space-x-3">
                            <button onclick="openMyPage()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                マイページ
                            </button>
                            <button onclick="logout()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                                ログアウト
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Search / New Question Area -->
        <div class="mb-8 sticky top-4 z-10">
            <div class="relative">
                <input type="text" id="search-input" placeholder="キーワードで質問を探す (例: リクルート 働き方)" class="w-full p-4 pl-12 text-lg border border-gray-300 rounded-full shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <svg class="absolute left-4 top-1/2 -translate-y-1/2 h-6 w-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </div>
             <button id="new-question-btn" class="mt-3 w-full md:w-auto md:absolute md:right-2 md:top-1/2 md:-translate-y-1/2 md:mt-0 bg-blue-600 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-700 transition-colors text-base">
                新しい質問をする
            </button>
        </div>

        <!-- Q&A Feed -->
        <main id="qa-feed" class="space-y-6">
            <!-- Q&A cards will be inserted here by JavaScript -->
        </main>
    </div>

    <!-- Q&A Detail Modal -->
    <div id="qa-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden modal-backdrop">
        <div id="modal-content" class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col opacity-0 transform scale-95">
            <div id="modal-body" class="p-8 overflow-y-auto">
                <!-- Modal content will be inserted here -->
            </div>
            <div class="p-4 bg-gray-50 border-t border-gray-200 rounded-b-2xl text-right">
                <button id="close-modal-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-full hover:bg-gray-300 transition-colors">閉じる</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden modal-backdrop">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md opacity-0 transform scale-95 transition-all duration-300">
            <div class="p-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-900">ログイン</h2>
                
                <!-- Login Form -->
                <form id="login-form" class="space-y-4 mb-6">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">メールアドレス</label>
                        <input type="email" id="login-email" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">パスワード</label>
                        <input type="password" id="login-password" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">
                        ログイン
                    </button>
                </form>
                
                <!-- Register Form -->
                <form id="register-form" class="space-y-4 mb-6 hidden">
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">メールアドレス</label>
                        <input type="email" id="register-email" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">パスワード</label>
                        <input type="password" id="register-password" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors">
                        新規登録
                    </button>
                </form>
                
                <!-- Google Login -->
                <div class="text-center">
                    <div class="border-t border-gray-200 my-4"></div>
                    <button onclick="googleLogin()" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-3 px-6 rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Googleでログイン
                    </button>
                </div>
                
                <!-- Toggle Forms -->
                <div class="text-center mt-4">
                    <button id="toggle-form-btn" onclick="toggleLoginForm()" class="text-blue-600 hover:text-blue-800 text-sm">
                        新規登録はこちら
                    </button>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t border-gray-200 rounded-b-2xl text-right">
                <button onclick="closeLoginModal()" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-full hover:bg-gray-300 transition-colors">閉じる</button>
            </div>
        </div>
    </div>


    <script>
        // --- Simulated Knowledge Base ---
        const knowledgeBase = [
            {
                id: 8,
                questioner: {
                    age: "20代後半",
                    industry: "IT・通信",
                    job: "エンジニア",
                },
                question: "リクルートの面接って圧迫面接ですか？",
                answer: `
                    <p class="mb-4">面接の雰囲気についてのご質問ですね。多くの候補者様が気にされるポイントです。</p>
                    <p class="mb-3"><strong>【結論】</strong><br>過去の志願者からの面接フィードバックによると、圧迫面接というよりかは、自分のことを言語化できているのか、過去の自分を自己分析できているのかを深掘りできるかを重要視されています。</p>
                    <div class="p-4 bg-blue-50 rounded-lg mb-4">
                        <h4 class="font-bold text-blue-800">面接の特徴</h4>
                        <ul class="list-disc list-inside mt-2 text-sm space-y-2">
                            <li><strong>深掘り重視:</strong> 表面的な回答ではなく、「なぜそう思ったのか」「どのような経験から学んだのか」を徹底的に聞かれます。これは圧迫ではなく、本当に理解したいという姿勢です。</li>
                            <li><strong>自己分析力の確認:</strong> 過去の経験を振り返り、そこから何を学び、どう成長したかを言語化できるかが重要です。曖昧な回答は避け、具体的なエピソードと学びを準備しておくことが大切です。</li>
                            <li><strong>論理的思考の確認:</strong> 感情的な回答ではなく、ロジカルに自分の考えを整理して伝えられるかが評価されます。</li>
                        </ul>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg mb-4">
                        <h4 class="font-bold text-green-800">面接官の意図</h4>
                        <ul class="list-disc list-inside mt-2 text-sm space-y-2">
                            <li><strong>キャリアの一貫性:</strong> なぜリクルートを選んだのか、どのようなキャリアを描いているのかの整合性を確認したい</li>
                            <li><strong>成長意欲:</strong> 過去の経験から学びを得て、それを次に活かそうとする姿勢があるか</li>
                            <li><strong>コミュニケーション能力:</strong> 複雑な考えを分かりやすく伝えられるか、チームで働く上で必要なスキル</li>
                        </ul>
                    </div>
                    <div class="p-4 bg-yellow-50 rounded-lg mb-4">
                        <h4 class="font-bold text-yellow-800">対策のポイント</h4>
                        <ul class="list-disc list-inside mt-2 text-sm space-y-2">
                            <li><strong>STAR法の活用:</strong> Situation（状況）、Task（課題）、Action（行動）、Result（結果）の順で具体的なエピソードを準備</li>
                            <li><strong>自己分析の深化:</strong> なぜその選択をしたのか、何を学んだのか、次にどう活かすのかを明確に</li>
                            <li><strong>リクルートへの理解:</strong> 企業理念や事業内容を深く理解し、なぜ自分がフィットするのかを具体的に説明できるように</li>
                        </ul>
                    </div>
                    <p class="mt-4 text-sm text-gray-600">面接は「圧迫」ではなく「深掘り」の場と考え、自分の経験と価値観をしっかり言語化できるように準備することをお勧めします。</p>
                `,
                tags: ["リクルート", "面接", "圧迫面接", "面接対策", "キャリア"],
                views: 298,
                likes: 42,
                infoSource: "過去の志願者からの面接フィードバックとエージェント会話ログ",
            },
            {
                id: 5,
                questioner: {
                    age: "20代後半",
                    industry: "Webサービス",
                    job: "マーケター",
                },
                question: "リクルートの働き方について。残業は多いですか？ワークライフバランスは取れますか？",
                answer: `
                    <p class="mb-4">働き方に関するご質問ですね。リクルートは「スマートワーク」を掲げており、働き方改革には全社で力を入れています。</p>
                    <p class="mb-3"><strong>【結論】</strong><br>部署や時期による、というのが実態ですが、全社的には残業時間は減少傾向にあります。月平均で20〜30時間程度の部署が多い印象です。</p>
                    <div class="p-4 bg-indigo-50 rounded-lg">
                        <h4 class="font-bold text-indigo-800">働き方のリアル</h4>
                        <ul class="list-disc list-inside mt-2 text-sm space-y-2">
                            <li><strong>残業:</strong> 繁忙期（四半期末など）は一時的に増えることもありますが、深夜残業や休日出勤が常態化している部署はほとんどありません。PCのログで労働時間は厳密に管理されています。</li>
                            <li><strong>有給休暇:</strong> 取得率は非常に高いです。年に数回、長期休暇（5営業日以上）を取得することが推奨されており、多くの社員が旅行などを楽しんでいます。</li>
                            <li><strong>リモートワーク:</strong> 多くの部署でリモートと出社のハイブリッドワークが浸透しています。チームの方針によりますが、週2〜3日のリモート勤務が一般的です。</li>
                        </ul>
                    </div>
                    <p class="mt-4 text-sm text-gray-600">「自分はどう働きたいか」という意思を尊重してくれる文化なので、面接で希望の働き方を率直に伝えてみるのが良いでしょう。</p>
                `,
                tags: ["リクルート", "働き方", "残業", "ワークライフバランス", "WLB"],
                views: 421,
                likes: 58,
                infoSource: "現役社員の匿名インタビューとエージェント会話ログ",
            },
            {
                id: 6,
                questioner: {
                    age: "30代前半",
                    industry: "不動産",
                    job: "営業",
                },
                question: "リクルートの給与体系について。ミッショングレード制とは具体的にどういうものですか？",
                answer: `
                    <p class="mb-4">給与体系、特にミッショングレード制についての質問ですね。これはリクルートの大きな特徴の一つです。</p>
                    <p class="mb-3"><strong>【結論】</strong><br>年齢や社歴ではなく「担うミッション（職務）の価値」によって報酬が決まる制度です。半期ごとにミッションの見直しがあり、その内容によって給与が変動します。</p>
                     <div class="p-4 bg-gray-100 rounded-lg">
                        <h4 class="font-bold">ミッショングレード制のポイント</h4>
                        <ul class="list-disc list-inside mt-2 text-sm space-y-2">
                            <li><strong>グレード定義:</strong> 全社で職務の価値に応じたグレードが設定されています。例えば、事業の根幹を担う戦略的なミッションはグレードが高く、定型的な業務は相対的にグレードが低くなります。</li>
                            <li><strong>半期ごとの査定:</strong> 上長との面談を通じて、次の半期で担うミッションとその難易度をすり合わせ、グレードが決定します。</li>
                            <li><strong>昇給・降給:</strong> より難易度の高いミッションに挑戦すれば大幅な昇給も可能ですし、逆も起こり得ます。この透明性と変動性が特徴です。</li>
                            <li><strong>インセンティブ:</strong> グレードに応じた基本給とは別に、目標達成度に応じたインセンティブ（賞与）が支給されます。</li>
                        </ul>
                    </div>
                    <p class="mt-4 text-sm text-gray-600">年功序列ではなく、常に挑戦し続ける人に報いるための制度と言えます。安定よりも変化や成長を求める方にはフィットしやすいでしょう。</p>
                `,
                tags: ["リクルート", "給与", "年収", "評価制度", "ミッショングレード"],
                views: 589,
                likes: 72,
                infoSource: "RAが保有する社内制度資料と転職成功者の体験談",
            },
            {
                id: 7,
                questioner: {
                    age: "20代後半",
                    industry: "IT",
                    job: "エンジニア",
                },
                question: "リクルートの社内異動制度「ミッショングラブ」は、本当に機能していますか？希望は通りやすいですか？",
                answer: `
                    <p class="mb-4">「ミッショングラブ」についてですね。キャリアの自律性を重んじるリクルートを象徴する制度です。</p>
                    <p class="mb-3"><strong>【結論】</strong><br>はい、非常に活発に機能しています。多くの社員がこの制度を使ってキャリアチェンジを実現しています。</p>
                    <div class="p-4 bg-teal-50 rounded-lg">
                        <h4 class="font-bold text-teal-800">ミッショングラブの実態</h4>
                        <ul class="list-disc list-inside mt-2 text-sm space-y-2">
                            <li><strong>仕組み:</strong> 社内のイントラネットに、様々な部署の募集ポジションが公開されています。社員は現上司の許可なく、自由に応募することができます。</li>
                            <li><strong>実現可能性:</strong> もちろん、異動には募集部署との面接があり、スキルや経験が求められます。しかし、「今の部署で成果を出していること」が前提にはなりますが、未経験の職種への異動も十分に可能です。</li>
                            <li><strong>活用例:</strong> 営業から企画職へ、メディアの担当から新規事業開発へ、といった異動が日常的に行われています。</li>
                        </ul>
                    </div>
                    <p class="mt-4 text-sm text-gray-600">「自分のキャリアは自分で決める」という意思が強い人にとっては、社内にいながら多様な経験を積める、非常に魅力的な制度です。</p>
                `,
                tags: ["リクルート", "キャリアパス", "社内異動", "ミッショングラブ", "キャリアチェンジ"],
                views: 350,
                likes: 41,
                infoSource: "エージェントの企業訪問記録と社内制度資料",
            },
            {
                id: 4,
                questioner: {
                    age: "20代前半",
                    industry: "広告・メディア",
                    job: "企画職",
                },
                question: "リクルートって、体育会系の文化が強いって本当ですか？飲み会とかも激しいんでしょうか？",
                answer: `
                    <p class="mb-4">「リクルートの社風」に関するご質問、ありがとうございます。これは昔からよく聞かれる質問ですね。</p>
                    <p class="mb-3"><strong>【結論】</strong><br>「体育会系」という言葉のイメージによりますが、「目標達成への意識が非常に高く、エネルギッシュな文化」という意味では、その側面は今でも存在します。ただし、一昔前の「飲み会が激しい」「上下関係が絶対」といったイメージとは大きく異なってきています。</p>
                    <div class="p-4 bg-yellow-50 rounded-lg">
                        <h4 class="font-bold text-yellow-800">リクルートの「体育会系」文化のリアル</h4>
                        <ul class="list-disc list-inside mt-2 text-sm space-y-2">
                            <li><strong>目標達成（G）への圧倒的当事者意識:</strong> チームや個人で設定した目標（Goal）に対して、どうすれば達成できるかを全員が考え、行動に移す文化が根付いています。この熱量が「体育会系」と表現されることが多いです。</li>
                            <li><strong>称賛の文化:</strong> 目標を達成した際には、チーム全体で盛大に称賛し合います。キックオフや表彰式などは非常に盛り上がります。</li>
                            <li><strong>飲み会や社内イベント:</strong> 昔に比べて強制的な参加は全くなく、多様な働き方が尊重されています。もちろん、イベント好きな社員も多いですが、参加は完全に任意です。</li>
                            <li><strong>ロジカルさも重視:</strong> 根性論だけでなく、データに基づいた議論やロジカルな思考も同様に重視されます。特に最近はその傾向が強まっています。</li>
                        </ul>
                    </div>
                    <p class="mt-4 text-sm text-gray-600">結論として、エネルギッシュな環境で目標達成にコミットしたい方には非常にフィットする文化ですが、いわゆる「体育会系のノリ」が苦手な方でも、ロジカルさや個人の意思が尊重されるため、活躍できる土壌は十分にあります。</p>
                `,
                tags: ["リクルート", "社風", "体育会系", "文化", "飲み会"],
                views: 312,
                likes: 45,
                infoSource: "現役・元社員の匿名インタビューとエージェント会話ログ",
            },
            {
                id: 1,
                questioner: {
                    age: "20代後半",
                    industry: "IT・通信",
                    job: "営業職",
                },
                question: "リクルートとパーソル、若手の裁量権と成長環境って、ぶっちゃけどう違いますか？",
                answer: `
                    <p class="mb-4">ご質問ありがとうございます。リクルートとパーソルの若手育成に関するリアルな情報ですね。多くの候補者様が気にされるポイントです。</p>
                    <p class="mb-3"><strong>【結論】</strong><br>早くから挑戦したいならリクルート、じっくり育ててほしいならパーソル、というのが元社員や現役社員から聞くリアルな声です。</p>
                    <div class="p-4 bg-blue-50 rounded-lg mb-4">
                        <h4 class="font-bold text-blue-800">リクルート：実践で学ぶ！挑戦環境</h4>
                        <ul class="list-disc list-inside mt-2 text-sm space-y-1">
                            <li>入社1年目からでも、手を挙げればプロジェクトの重要部分を任される。</li>
                            <li>「まずやってみろ」の文化。失敗から学ぶ姿勢が評価される。</li>
                            <li><strong>注意点：</strong>受け身だと放置される可能性も。自走力が求められます。</li>
                        </ul>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg">
                        <h4 class="font-bold text-green-800">パーソル：丁寧な育成！安心環境</h4>
                        <ul class="list-disc list-inside mt-2 text-sm space-y-1">
                            <li>3年目頃まで手厚いOJTと研修制度が充実。</li>
                            <li>先輩がしっかりサポートしてくれるので、未経験分野でも安心。</li>
                            <li><strong>注意点：</strong>独り立ちのスピードはリクルートに比べると緩やかです。</li>
                        </ul>
                    </div>
                    <p class="mt-4 text-sm text-gray-600">※上記は多数のヒアリングに基づく傾向であり、部署やチームによって異なる場合があります。</p>
                `,
                tags: ["リクルート", "パーソル", "裁量権", "成長環境", "若手"],
                views: 128,
                likes: 15,
                infoSource: "エージェントの企業比較データと転職成功者の体験談",
            }
        ];

        // --- DOM Elements ---
        const searchInput = document.getElementById('search-input');
        const qaFeed = document.getElementById('qa-feed');
        const modal = document.getElementById('qa-modal');
        const modalContent = document.getElementById('modal-content');
        const modalBody = document.getElementById('modal-body');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const newQuestionBtn = document.getElementById('new-question-btn');

        // --- Functions ---

        // Render Q&A cards
        const renderFeed = (items) => {
            qaFeed.innerHTML = '';
            if (items.length === 0) {
                qaFeed.innerHTML = `<div class="text-center p-10 bg-white rounded-lg shadow-sm"><p class="text-gray-500">該当する質問が見つかりませんでした。</p></div>`;
                return;
            }
            items.forEach(item => {
                const card = document.createElement('article');
                card.className = 'q-card bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer';
                card.onclick = () => openModal(item);
                
                const answerExcerpt = item.answer.split('</p>')[0].replace(/<p class="mb-4">/g, '') + '...</p>';

                card.innerHTML = `
                    <div class="flex items-start mb-3">
                        <div class="flex-shrink-0 mr-3">
                            <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                            </div>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">${item.questioner.age}, ${item.questioner.job}</p>
                            <p class="text-sm text-gray-500">${item.questioner.industry}業界</p>
                        </div>
                    </div>
                    <h2 class="text-xl font-bold mb-3 text-gray-900">${item.question}</h2>
                    <div class="text-gray-600 text-sm mb-4">${answerExcerpt}</div>
                    <div class="flex justify-between items-center text-sm text-gray-500">
                        <div class="flex flex-wrap gap-2">
                            ${item.tags.map(tag => `<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-md text-xs font-medium">#${tag}</span>`).join('')}
                        </div>
                        <div class="flex items-center space-x-4 flex-shrink-0 mt-2 md:mt-0">
                            <span class="flex items-center"><svg class="h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C3.732 4.943 7.523 3 10 3s6.268 1.943 9.542 7c-3.274 5.057-7.03 7-9.542 7S3.732 15.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>${item.views}</span>
                            <button onclick="toggleLike(${item.id}, event)" class="flex items-center hover:text-red-500 transition-colors">
                                <svg class="h-4 w-4 mr-1 ${item.userLiked ? 'text-red-500 fill-current' : 'text-gray-400'}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                                </svg>
                                <span class="${item.userLiked ? 'text-red-500' : 'text-gray-500'}">${item.likes}</span>
                            </button>
                        </div>
                    </div>
                `;
                qaFeed.appendChild(card);
            });
        };

        // Open Q&A detail modal
        const openModal = (item) => {
            modalBody.innerHTML = `
                <div class="flex items-start mb-4">
                    <div class="flex-shrink-0 mr-4">
                        <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        </div>
                    </div>
                    <div>
                        <p class="font-bold text-lg text-gray-800">${item.questioner.age}, ${item.questioner.job}</p>
                        <p class="text-md text-gray-500">${item.questioner.industry}業界</p>
                    </div>
                </div>
                <h2 class="text-2xl font-bold mb-6 text-gray-900">${item.question}</h2>
                <div class="border-t border-gray-200 pt-6">
                    <div class="flex items-center mb-4">
                         <div class="flex-shrink-0 mr-4">
                            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                            </div>
                        </div>
                        <p class="font-bold text-lg text-gray-800">キャリアアドバイザーの回答</p>
                    </div>
                    <div class="prose max-w-none text-gray-700">${item.answer}</div>
                </div>
            `;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
                modalContent.classList.remove('opacity-0', 'scale-95');
                modalContent.classList.add('opacity-100', 'scale-100');
            }, 10);
        };
        
        // Open new question modal (simulation)
        const openNewQuestionModal = () => {
             modalBody.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-gray-900">新しい質問を投稿する</h2>
                <p class="text-sm text-gray-600 mb-6">ご質問は匿名で公開され、他の転職活動中の方の参考になります。個人が特定できる情報は含めないようご注意ください。</p>
                
                <form id="new-question-form" class="space-y-4">
                    <div>
                        <label for="question-title" class="block text-sm font-medium text-gray-700 mb-1">質問（タイトル）</label>
                        <input type="text" id="question-title" class="w-full p-2 border border-gray-300 rounded-md" placeholder="例：リクルートの残業時間の実態について" required>
                    </div>
                    <div>
                        <label for="question-detail" class="block text-sm font-medium text-gray-700 mb-1">質問の詳細（任意）</label>
                        <textarea id="question-detail" rows="4" class="w-full p-2 border border-gray-300 rounded-md" placeholder="背景や特に知りたい点など"></textarea>
                    </div>
                     <div class="text-right">
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-700 transition-colors">この内容で質問する</button>
                    </div>
                </form>
            `;
            
            // Add form submit event listener
            const form = document.getElementById('new-question-form');
            form.addEventListener('submit', submitNewQuestion);
            
            // Clear any existing form data
            setTimeout(() => {
                const titleInput = document.getElementById('question-title');
                const detailInput = document.getElementById('question-detail');
                if (titleInput) titleInput.value = '';
                if (detailInput) detailInput.value = '';
            }, 50);
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
                modalContent.classList.remove('opacity-0', 'scale-95');
                modalContent.classList.add('opacity-100', 'scale-100');
            }, 10);
        }

        // Submit new question
        const submitNewQuestion = async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('question-title').value.trim();
            const detail = document.getElementById('question-detail').value.trim();
            
            if (!title) {
                alert('質問のタイトルを入力してください。');
                return;
            }
            
            // Get submit button and change its state
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = `
                <svg class="inline-block w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                投稿中...
            `;
            submitButton.disabled = true;
            submitButton.classList.add('opacity-50');
            
            // Add a safety timeout to reset button after 10 seconds
            const safetyTimeout = setTimeout(() => {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50');
                console.log('Button reset by safety timeout');
            }, 10000);
            
            try {
                // Create question ID
                const questionId = Date.now();
                
                // Generate AI response based on question content
                const aiResponse = generateAIResponse(title, detail, questionId);
                console.log('Generated AI response:', aiResponse); // Debug log
                
                // Create new question object
                const newQuestion = {
                    id: questionId,
                    questioner: {
                        age: "匿名",
                        industry: "匿名",
                        job: "匿名",
                    },
                    question: title,
                    answer: aiResponse,
                    tags: ["新規質問", "AI回答"],
                    views: 0,
                    likes: 0,
                    hasAIResponse: true,
                    needsRA: false
                };
                
                // Save to Firestore if available
                if (window.db) {
                    try {
                        const savedId = await saveQuestionToFirestore(newQuestion);
                        if (savedId) {
                            newQuestion.id = savedId; // Use Firestore ID
                            newQuestion.userId = currentUser?.uid || null; // Add user ID
                            console.log('Question saved to Firestore with ID:', savedId);
                        } else {
                            console.error('Failed to save question to Firestore');
                        }
                    } catch (error) {
                        console.error('Error saving to Firestore:', error);
                    }
                }
                
                // Add to knowledge base for immediate display
                knowledgeBase.unshift(newQuestion);
                console.log('Added question to knowledge base:', newQuestion); // Debug log
                
                // Re-render feed
                renderFeed(knowledgeBase);
                
                // Highlight the new question
                setTimeout(() => {
                    const firstCard = document.querySelector('.q-card');
                    if (firstCard) {
                        firstCard.style.transform = 'scale(1.02)';
                        firstCard.style.boxShadow = '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)';
                        firstCard.style.borderColor = '#3B82F6';
                        
                        // Reset after 2 seconds
                        setTimeout(() => {
                            firstCard.style.transform = '';
                            firstCard.style.boxShadow = '';
                            firstCard.style.borderColor = '';
                        }, 2000);
                    }
                }, 100);
                
                // Clear the form
                document.getElementById('question-title').value = '';
                document.getElementById('question-detail').value = '';
                
                // Clear safety timeout
                clearTimeout(safetyTimeout);
                
                // Reset button state BEFORE closing modal
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50');
                
                // Close modal
                closeModal();
                
                // Show success message with visual feedback
                setTimeout(() => {
                    // Create a success notification
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300';
                    notification.innerHTML = `
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            質問を投稿しました！AIが回答を生成しました。
                        </div>
                    `;
                    document.body.appendChild(notification);
                    
                    // Animate in
                    setTimeout(() => {
                        notification.style.transform = 'translateX(0)';
                    }, 100);
                    
                    // Remove after 3 seconds
                    setTimeout(() => {
                        notification.style.transform = 'translateX(100%)';
                        setTimeout(() => {
                            document.body.removeChild(notification);
                        }, 300);
                    }, 3000);
                }, 100);
                
                // Update my page if it's open
                const mypageModal = document.getElementById('mypage-modal');
                if (!mypageModal.classList.contains('hidden')) {
                    loadMyQuestions();
                }
                
            } catch (error) {
                console.error('Error submitting question:', error);
                
                // Clear safety timeout
                clearTimeout(safetyTimeout);
                
                // Reset button state on error
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50');
                
                // Show error notification
                const errorNotification = document.createElement('div');
                errorNotification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300';
                errorNotification.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        投稿に失敗しました。もう一度お試しください。
                    </div>
                `;
                document.body.appendChild(errorNotification);
                
                // Animate in
                setTimeout(() => {
                    errorNotification.style.transform = 'translateX(0)';
                }, 100);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    errorNotification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(errorNotification);
                    }, 300);
                }, 3000);
            }
        };

        // Generate AI response
        const generateAIResponse = (title, detail, questionId) => {
            const questionText = title + (detail ? ' ' + detail : '');
            const lowerQuestion = questionText.toLowerCase();
            
            // Simple AI response logic based on keywords
            let response = '';
            let confidence = '';
            let reliability = '';
            
            if (lowerQuestion.includes('リクルート') || lowerQuestion.includes('recruit')) {
                if (lowerQuestion.includes('面接') || lowerQuestion.includes('圧迫')) {
                    response = `
                        <p class="mb-4">リクルートの面接についてのご質問ですね。</p>
                        <p class="mb-3"><strong>【AI回答】</strong><br>過去の志願者からの面接フィードバックによると、圧迫面接というよりかは、自分のことを言語化できているのか、過去の自分を自己分析できているのかを深掘りできるかを重要視されています。</p>
                        <div class="p-4 bg-blue-50 rounded-lg mb-4">
                            <h4 class="font-bold text-blue-800">面接の特徴</h4>
                            <ul class="list-disc list-inside mt-2 text-sm space-y-1">
                                <li>深掘り重視：表面的な回答ではなく、なぜそう思ったのかを徹底的に聞かれる</li>
                                <li>自己分析力の確認：過去の経験から何を学んだかを言語化できるかが重要</li>
                                <li>論理的思考の確認：ロジカルに自分の考えを整理して伝えられるかが評価される</li>
                            </ul>
                        </div>
                        <div class="p-4 bg-green-50 rounded-lg mb-4">
                            <h4 class="font-bold text-green-800">対策のポイント</h4>
                            <ul class="list-disc list-inside mt-2 text-sm space-y-1">
                                <li>STAR法の活用：具体的なエピソードを準備</li>
                                <li>自己分析の深化：なぜその選択をしたのかを明確に</li>
                                <li>リクルートへの理解：企業理念を深く理解し、なぜ自分がフィットするのかを説明</li>
                            </ul>
                        </div>
                    `;
                    confidence = '高';
                    reliability = '過去の志願者からの面接フィードバックに基づく';
                } else if (lowerQuestion.includes('働き方') || lowerQuestion.includes('残業') || lowerQuestion.includes('wlb')) {
                    response = `
                        <p class="mb-4">リクルートの働き方についてのご質問ですね。</p>
                        <p class="mb-3"><strong>【AI回答】</strong><br>リクルートは「スマートワーク」を推進しており、全社的に働き方改革に取り組んでいます。月平均残業時間は20〜30時間程度の部署が多いとされています。</p>
                        <div class="p-4 bg-blue-50 rounded-lg mb-4">
                            <h4 class="font-bold text-blue-800">主な特徴</h4>
                            <ul class="list-disc list-inside mt-2 text-sm space-y-1">
                                <li>リモートワークと出社のハイブリッド勤務が一般的</li>
                                <li>有給休暇の取得率が高い</li>
                                <li>PCログによる労働時間の厳密な管理</li>
                                <li>繁忙期以外は深夜残業は少ない</li>
                            </ul>
                        </div>
                    `;
                    confidence = '高';
                    reliability = '現役社員・元社員の匿名インタビューとエージェント会話ログに基づく';
                } else if (lowerQuestion.includes('給与') || lowerQuestion.includes('年収') || lowerQuestion.includes('ミッショングレード')) {
                    response = `
                        <p class="mb-4">リクルートの給与体系についてのご質問ですね。</p>
                        <p class="mb-3"><strong>【AI回答】</strong><br>リクルートは「ミッショングレード制」を採用しており、年齢や社歴ではなく担う職務の価値によって報酬が決まります。半期ごとにミッションの見直しがあり、給与が変動する可能性があります。</p>
                        <div class="p-4 bg-green-50 rounded-lg mb-4">
                            <h4 class="font-bold text-green-800">ミッショングレード制の特徴</h4>
                            <ul class="list-disc list-inside mt-2 text-sm space-y-1">
                                <li>職務の価値に応じたグレード設定</li>
                                <li>半期ごとの査定とミッション見直し</li>
                                <li>挑戦的なミッションで大幅昇給の可能性</li>
                                <li>目標達成度に応じたインセンティブ</li>
                            </ul>
                        </div>
                    `;
                    confidence = '中';
                    reliability = 'RAが保有する社内制度資料と転職成功者の体験談に基づく';
                } else {
                    response = `
                        <p class="mb-4">リクルートについてのご質問ですね。</p>
                        <p class="mb-3"><strong>【AI回答】</strong><br>リクルートは日本の大手人材サービス企業で、転職エージェント「リクルートエージェント」や求人サイト「リクナビ」などを運営しています。働き方改革やキャリア自律を重視する文化で知られています。</p>
                        <div class="p-4 bg-yellow-50 rounded-lg mb-4">
                            <h4 class="font-bold text-yellow-800">企業の特徴</h4>
                            <ul class="list-disc list-inside mt-2 text-sm space-y-1">
                                <li>人材サービス業界のリーディングカンパニー</li>
                                <li>ミッショングレード制による成果主義</li>
                                <li>社内異動制度「ミッショングラブ」</li>
                                <li>目標達成への高い意識を持つ文化</li>
                            </ul>
                        </div>
                    `;
                    confidence = '高';
                    reliability = 'エージェントの企業訪問記録と転職成功者のフィードバックに基づく';
                }
            } else if (lowerQuestion.includes('リクルート') && lowerQuestion.includes('パーソル')) {
                response = `
                    <p class="mb-4">リクルートとパーソルの比較についてのご質問ですね。</p>
                    <p class="mb-3"><strong>【AI回答】</strong><br>一般的に、リクルートは若手に早くから挑戦機会を与える「実践型」、パーソルは丁寧な育成を重視する「教育型」の傾向があります。ただし、これは一般的な傾向であり、実際は部署やチームによって大きく異なる可能性があります。</p>
                    <div class="p-4 bg-purple-50 rounded-lg mb-4">
                        <h4 class="font-bold text-purple-800">一般的な比較</h4>
                        <ul class="list-disc list-inside mt-2 text-sm space-y-1">
                            <li><strong>リクルート:</strong> 早期からの裁量権、失敗を許容する文化</li>
                            <li><strong>パーソル:</strong> 手厚いOJT、段階的な成長支援</li>
                            <li>どちらも一長一短があり、個人の志向性が重要</li>
                        </ul>
                    </div>
                `;
                confidence = '中';
                reliability = 'エージェントの企業比較データと転職成功者の体験談に基づく';
            } else {
                response = `
                    <p class="mb-4">ご質問ありがとうございます。</p>
                    <p class="mb-3"><strong>【AI回答】</strong><br>申し訳ございませんが、この質問に対する具体的な情報が不足しているため、正確な回答を提供することができません。より詳細な情報や具体的な企業名、職種などを教えていただけますでしょうか？</p>
                    ${detail ? `<div class="p-4 bg-gray-50 rounded-lg mb-4"><h4 class="font-bold">質問の詳細</h4><p class="text-sm">${detail}</p></div>` : ''}
                    <div class="p-4 bg-orange-50 rounded-lg mb-4">
                        <h4 class="font-bold text-orange-800">より良い回答のために</h4>
                        <ul class="list-disc list-inside mt-2 text-sm space-y-1">
                            <li>具体的な企業名や業界</li>
                            <li>職種や役職</li>
                            <li>知りたい具体的な内容</li>
                            <li>ご自身の状況や背景</li>
                        </ul>
                    </div>
                `;
                confidence = '低';
                reliability = '情報不足のため推測に基づく';
            }
            
            // Add confidence and reliability info
            response += `
                <div class="p-4 bg-gray-100 rounded-lg mb-4">
                    <h4 class="font-bold text-gray-800">回答の信頼性について</h4>
                    <div class="grid grid-cols-2 gap-4 mt-2 text-sm">
                        <div>
                            <span class="font-medium">信頼度:</span> 
                            <span class="px-2 py-1 rounded text-xs font-medium ${
                                confidence === '高' ? 'bg-green-100 text-green-800' : 
                                confidence === '中' ? 'bg-yellow-100 text-yellow-800' : 
                                'bg-red-100 text-red-800'
                            }">${confidence}</span>
                        </div>
                        <div>
                            <span class="font-medium">情報源:</span> 
                            <span class="text-gray-600">${reliability}</span>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <button onclick="askRA(${questionId})" class="bg-red-600 text-white font-bold py-2 px-6 rounded-full hover:bg-red-700 transition-colors">
                        <svg class="inline-block w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        RAに回答依頼をする
                    </button>
                </div>
            `;
            
            return response;
        };

        // Toggle like function
        const toggleLike = (questionId, event) => {
            event.stopPropagation(); // Prevent modal from opening
            
            const question = knowledgeBase.find(q => q.id === questionId);
            if (question) {
                if (question.userLiked) {
                    question.likes--;
                    question.userLiked = false;
                } else {
                    question.likes++;
                    question.userLiked = true;
                }
                
                // Update the button appearance
                const button = event.currentTarget;
                const icon = button.querySelector('svg');
                const count = button.querySelector('span');
                
                if (question.userLiked) {
                    icon.classList.add('text-red-500', 'fill-current');
                    icon.classList.remove('text-gray-400');
                    count.classList.add('text-red-500');
                    count.classList.remove('text-gray-500');
                } else {
                    icon.classList.remove('text-red-500', 'fill-current');
                    icon.classList.add('text-gray-400');
                    count.classList.remove('text-red-500');
                    count.classList.add('text-gray-500');
                }
                
                count.textContent = question.likes;
                
                // Save to localStorage for persistence
                const likedQuestions = JSON.parse(localStorage.getItem('likedQuestions') || '[]');
                if (question.userLiked) {
                    if (!likedQuestions.includes(questionId)) {
                        likedQuestions.push(questionId);
                    }
                } else {
                    const index = likedQuestions.indexOf(questionId);
                    if (index > -1) {
                        likedQuestions.splice(index, 1);
                    }
                }
                localStorage.setItem('likedQuestions', JSON.stringify(likedQuestions));
            }
        };

        // Ask RA function
        const askRA = (questionId) => {
            const question = knowledgeBase.find(q => q.id === questionId);
            if (question) {
                question.needsRA = true;
                question.tags = question.tags.filter(tag => tag !== 'AI回答');
                question.tags.push('RA相談中');
                
                // Update the answer to show RA consultation status
                question.answer = question.answer.replace(
                    /<div class="text-center">.*?<\/div>/s,
                    `<div class="p-4 bg-blue-50 rounded-lg mb-4">
                        <h4 class="font-bold text-blue-800">RA回答依頼中</h4>
                        <p class="text-sm">この質問はRAが詳しく調査中です。より正確で詳細な回答をお届けします。</p>
                    </div>`
                );
                
                renderFeed(knowledgeBase);
                alert('RAに回答依頼を送信しました。より詳細な回答を準備いたします。');
            }
        };

        // Close modal
        const closeModal = () => {
            modal.classList.remove('opacity-100');
            modalContent.classList.remove('opacity-100', 'scale-100');
            modalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        };

        // Filter feed based on search input
        const filterFeed = () => {
            const query = searchInput.value.toLowerCase().trim();
            if (!query) {
                renderFeed(knowledgeBase);
                return;
            }
            const filtered = knowledgeBase.filter(item => {
                const searchableText = [item.question, ...item.tags].join(' ').toLowerCase();
                return searchableText.includes(query);
            });
            renderFeed(filtered);
        };

        // --- Event Listeners ---
        searchInput.addEventListener('input', filterFeed);
        closeModalBtn.addEventListener('click', closeModal);
        newQuestionBtn.addEventListener('click', openNewQuestionModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });
        
        // Login form event listeners
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            emailLogin(email, password);
        });
        
        document.getElementById('register-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            emailRegister(email, password);
        });
        
        // Login modal close on backdrop click
        document.getElementById('login-modal').addEventListener('click', (e) => {
            if (e.target.id === 'login-modal') {
                closeLoginModal();
            }
        });

        // --- Authentication Functions ---
        
        // Global user state
        let currentUser = null;
        
        // Open login modal
        const openLoginModal = () => {
            const modal = document.getElementById('login-modal');
            const modalContent = modal.querySelector('.bg-white');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
                modalContent.classList.remove('opacity-0', 'scale-95');
                modalContent.classList.add('opacity-100', 'scale-100');
            }, 10);
        };
        
        // Close login modal
        const closeLoginModal = () => {
            const modal = document.getElementById('login-modal');
            const modalContent = modal.querySelector('.bg-white');
            modal.classList.remove('opacity-100');
            modalContent.classList.remove('opacity-100', 'scale-100');
            modalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        };
        
        // Toggle between login and register forms
        const toggleLoginForm = () => {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const toggleBtn = document.getElementById('toggle-form-btn');
            
            if (loginForm.classList.contains('hidden')) {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                toggleBtn.textContent = '新規登録はこちら';
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                toggleBtn.textContent = 'ログインはこちら';
            }
        };
        
        // Google login
        const googleLogin = async () => {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                currentUser = result.user;
                closeLoginModal();
                updateAuthUI();
                showNotification('Googleでログインしました！', 'success');
            } catch (error) {
                console.error('Google login error:', error);
                showNotification('ログインに失敗しました。', 'error');
            }
        };
        
        // Email/password login
        const emailLogin = async (email, password) => {
            try {
                const result = await signInWithEmailAndPassword(auth, email, password);
                currentUser = result.user;
                closeLoginModal();
                updateAuthUI();
                showNotification('ログインしました！', 'success');
            } catch (error) {
                console.error('Login error:', error);
                showNotification('ログインに失敗しました。', 'error');
            }
        };
        
        // Email/password register
        const emailRegister = async (email, password) => {
            try {
                const result = await createUserWithEmailAndPassword(auth, email, password);
                currentUser = result.user;
                closeLoginModal();
                updateAuthUI();
                showNotification('アカウントを作成しました！', 'success');
            } catch (error) {
                console.error('Register error:', error);
                showNotification('アカウント作成に失敗しました。', 'error');
            }
        };
        
        // Logout
        const logout = async () => {
            try {
                await signOut(auth);
                currentUser = null;
                updateAuthUI();
                showNotification('ログアウトしました。', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('ログアウトに失敗しました。', 'error');
            }
        };
        
        // Update auth UI
        const updateAuthUI = () => {
            const authButtons = document.getElementById('auth-buttons');
            const userMenu = document.getElementById('user-menu');
            
            if (currentUser) {
                authButtons.classList.add('hidden');
                userMenu.classList.remove('hidden');
            } else {
                authButtons.classList.remove('hidden');
                userMenu.classList.add('hidden');
            }
        };
        
        // Show notification
        const showNotification = (message, type = 'info') => {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            notification.innerHTML = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        };
        
        // Open my page
        const openMyPage = () => {
            if (!currentUser) {
                showNotification('ログインしてください。', 'error');
                return;
            }
            
            // Update user info
            document.getElementById('user-name').textContent = currentUser.displayName || currentUser.email.split('@')[0];
            document.getElementById('user-email').textContent = currentUser.email;
            
            // Load my questions and liked questions
            loadMyQuestions();
            loadLikedQuestions();
            
            // Show modal
            const modal = document.getElementById('mypage-modal');
            const modalContent = modal.querySelector('.bg-white');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
                modalContent.classList.remove('opacity-0', 'scale-95');
                modalContent.classList.add('opacity-100', 'scale-100');
            }, 10);
        };
        
        // Close my page modal
        const closeMyPageModal = () => {
            const modal = document.getElementById('mypage-modal');
            const modalContent = modal.querySelector('.bg-white');
            modal.classList.remove('opacity-100');
            modalContent.classList.remove('opacity-100', 'scale-100');
            modalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        };
        
        // Switch tabs
        const switchTab = (tabName) => {
            const myQuestionsTab = document.getElementById('tab-my-questions');
            const likedQuestionsTab = document.getElementById('tab-liked-questions');
            const myQuestionsContent = document.getElementById('my-questions-content');
            const likedQuestionsContent = document.getElementById('liked-questions-content');
            
            if (tabName === 'my-questions') {
                myQuestionsTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                myQuestionsTab.classList.remove('text-gray-500');
                likedQuestionsTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                likedQuestionsTab.classList.add('text-gray-500');
                
                myQuestionsContent.classList.remove('hidden');
                likedQuestionsContent.classList.add('hidden');
            } else {
                likedQuestionsTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                likedQuestionsTab.classList.remove('text-gray-500');
                myQuestionsTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                myQuestionsTab.classList.add('text-gray-500');
                
                likedQuestionsContent.classList.remove('hidden');
                myQuestionsContent.classList.add('hidden');
            }
        };
        
        // Load my questions
        const loadMyQuestions = () => {
            const myQuestionsList = document.getElementById('my-questions-list');
            
            if (!currentUser) {
                myQuestionsList.innerHTML = `
                    <div class="text-center p-8 bg-gray-50 rounded-lg">
                        <p class="text-gray-500">ログインしてください</p>
                    </div>
                `;
                return;
            }
            
            // Get questions from knowledgeBase that belong to current user
            const myQuestions = knowledgeBase.filter(q => q.userId === currentUser.uid);
            console.log('My questions:', myQuestions); // Debug log
            console.log('Current user ID:', currentUser.uid); // Debug log
            console.log('All questions:', knowledgeBase.map(q => ({ id: q.id, userId: q.userId }))); // Debug log
            
            if (myQuestions.length === 0) {
                myQuestionsList.innerHTML = `
                    <div class="text-center p-8 bg-gray-50 rounded-lg">
                        <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-gray-500">まだ質問を投稿していません</p>
                        <button onclick="closeMyPageModal(); openNewQuestionModal()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            質問を投稿する
                        </button>
                    </div>
                `;
            } else {
                myQuestionsList.innerHTML = myQuestions.map(question => `
                    <div class="bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition-shadow cursor-pointer" onclick="openModal(${JSON.stringify(question).replace(/"/g, '&quot;')})">
                        <h3 class="font-bold text-lg mb-2">${question.question}</h3>
                        <div class="flex items-center text-sm text-gray-500 mb-2">
                            <span class="mr-4">投稿日: ${new Date(question.timestamp?.toDate?.() || Date.now()).toLocaleDateString()}</span>
                            <span class="mr-4">いいね: ${question.likes}</span>
                            <span>閲覧: ${question.views}</span>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${question.tags.map(tag => `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">#${tag}</span>`).join('')}
                        </div>
                    </div>
                `).join('');
            }
        };
        
        // Load liked questions
        const loadLikedQuestions = () => {
            const likedQuestionsList = document.getElementById('liked-questions-list');
            
            const likedQuestions = knowledgeBase.filter(q => q.userLiked);
            
            if (likedQuestions.length === 0) {
                likedQuestionsList.innerHTML = `
                    <div class="text-center p-8 bg-gray-50 rounded-lg">
                        <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                        <p class="text-gray-500">まだいいねした質問がありません</p>
                        <p class="text-sm text-gray-400 mt-2">気になる質問にいいねしてみましょう</p>
                    </div>
                `;
            } else {
                likedQuestionsList.innerHTML = likedQuestions.map(question => `
                    <div class="bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition-shadow cursor-pointer" onclick="openModal(${JSON.stringify(question).replace(/"/g, '&quot;')})">
                        <h3 class="font-bold text-lg mb-2">${question.question}</h3>
                        <div class="flex items-center text-sm text-gray-500 mb-2">
                            <span class="mr-4">投稿者: ${question.questioner.age}, ${question.questioner.job}</span>
                            <span class="mr-4">いいね: ${question.likes}</span>
                            <span>閲覧: ${question.views}</span>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${question.tags.map(tag => `<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">#${tag}</span>`).join('')}
                        </div>
                    </div>
                `).join('');
            }
        };
        
        // --- Firebase Functions ---
        
        // Load questions from Firestore
        const loadQuestionsFromFirestore = async () => {
            try {
                console.log('Attempting to load questions from Firestore...');
                const q = query(collection(db, "questions"), orderBy("timestamp", "desc"));
                
                // Set up real-time listener
                onSnapshot(q, (querySnapshot) => {
                    console.log('Firestore snapshot received:', querySnapshot.size, 'documents');
                    const firestoreQuestions = [];
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        console.log('Document data:', doc.id, data);
                        firestoreQuestions.push({
                            id: doc.id,
                            questioner: data.questioner || { age: "匿名", industry: "匿名", job: "匿名" },
                            question: data.question,
                            answer: data.answer,
                            tags: data.tags || [],
                            views: data.views || 0,
                            likes: data.likes || 0,
                            hasAIResponse: data.hasAIResponse || false,
                            needsRA: data.needsRA || false,
                            userId: data.userId || null,
                            timestamp: data.timestamp
                        });
                    });
                    
                    // Update knowledgeBase with Firestore data
                    knowledgeBase.length = 0; // Clear existing data
                    knowledgeBase.push(...firestoreQuestions, ...knowledgeBase.filter(q => !q.userId)); // Add Firestore data + static data
                    
                    // Combine with static knowledge base
                    const allQuestions = [...firestoreQuestions, ...knowledgeBase];
                    renderFeed(allQuestions);
                    console.log('Real-time update: Loaded questions from Firestore:', firestoreQuestions.length);
                }, (error) => {
                    console.error("Firestore listener error: ", error);
                    renderFeed(knowledgeBase);
                });
                
            } catch (error) {
                console.error("Error loading questions: ", error);
                renderFeed(knowledgeBase);
            }
        };
        
        // Save new question to Firestore
        const saveQuestionToFirestore = async (questionData) => {
            try {
                console.log('Attempting to save question to Firestore:', questionData);
                const docRef = await addDoc(collection(db, "questions"), {
                    questioner: questionData.questioner,
                    question: questionData.question,
                    answer: questionData.answer,
                    tags: questionData.tags,
                    views: questionData.views,
                    likes: questionData.likes,
                    hasAIResponse: questionData.hasAIResponse,
                    needsRA: questionData.needsRA,
                    userId: currentUser?.uid || null,
                    timestamp: serverTimestamp()
                });
                console.log("Question saved with ID: ", docRef.id);
                return docRef.id;
            } catch (error) {
                console.error("Error saving question: ", error);
                console.error("Error details:", error.message, error.code);
                return null;
            }
        };
        
        // --- Initial Render ---
        // Wait for Firebase to initialize, then load questions
        const initializeApp = () => {
            // Restore liked questions from localStorage
            const likedQuestions = JSON.parse(localStorage.getItem('likedQuestions') || '[]');
            knowledgeBase.forEach(question => {
                question.userLiked = likedQuestions.includes(question.id);
            });
            
            if (window.db) {
                console.log('Firebase initialized, loading questions...');
                loadQuestionsFromFirestore();
            } else {
                console.log('Firebase not available, using static data...');
                renderFeed(knowledgeBase);
            }
        };
        
        // Initialize auth state listener
        const initializeAuth = () => {
            if (window.auth) {
                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    updateAuthUI();
                    console.log('Auth state changed:', user ? user.email : 'No user');
                });
            }
        };
        
        // Add event listeners for modal backdrops
        document.addEventListener('DOMContentLoaded', () => {
            // My page modal backdrop
            const mypageModal = document.getElementById('mypage-modal');
            mypageModal.addEventListener('click', (e) => {
                if (e.target === mypageModal) {
                    closeMyPageModal();
                }
            });
        });
        
        // Try to initialize immediately, then retry after a delay
        initializeApp();
        initializeAuth();
        setTimeout(() => {
            initializeApp();
            initializeAuth();
        }, 2000);
    </script>

    <!-- My Page Modal -->
    <div id="mypage-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden modal-backdrop">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl max-h-[90vh] opacity-0 transform scale-95 transition-all duration-300">
            <div class="p-8 overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">マイページ</h2>
                    <button onclick="closeMyPageModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- User Info -->
                <div class="bg-blue-50 rounded-lg p-4 mb-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg" id="user-name">ユーザー名</h3>
                            <p class="text-gray-600" id="user-email">user@example.com</p>
                        </div>
                    </div>
                </div>
                
                <!-- Tabs -->
                <div class="flex border-b border-gray-200 mb-6">
                    <button id="tab-my-questions" onclick="switchTab('my-questions')" class="px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600">
                        私の質問
                    </button>
                    <button id="tab-liked-questions" onclick="switchTab('liked-questions')" class="px-4 py-2 font-medium text-gray-500 hover:text-gray-700">
                        いいねした質問
                    </button>
                </div>
                
                <!-- My Questions Tab -->
                <div id="my-questions-content" class="space-y-4">
                    <div id="my-questions-list">
                        <!-- My questions will be loaded here -->
                    </div>
                </div>
                
                <!-- Liked Questions Tab -->
                <div id="liked-questions-content" class="space-y-4 hidden">
                    <div id="liked-questions-list">
                        <!-- Liked questions will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>